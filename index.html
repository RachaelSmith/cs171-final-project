<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>CS171 Final Project</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>


    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

    <!-- add own scripts-->
    <script src = "js/worldvis.js"></script>

</head>
<body>
    <div class="container">
        <h1>Global CO2 and Energy Usage</h1>

        <div class="row">
            <div class="col-md-8 col-sm-12">
               <p> The following visualization shows you the global carbon emissions from 1960-2014. Press play to see the animation. Click a country to see its detailed energy profile.</p>
            </div>

        </div>

        <div class="row">
            <div class="col-md-5">
                <button class="btn btn-sm btn-primary" id="gdpBtn"> GDP </button>
                <button class="btn btn-sm btn-primary" id="popBtn"> Population </button>
                <button class="btn btn-sm btn-primary" id="frBtn"> % Forest Area </button>
            </div>


        </div>


        <div class="row">
            <div class="col-md-8" id="worldVis">
                <!-- TODO: delete placeholder svg element -->
               <!--  <svg width="750" height="600" style="background-color: lightblue">
                    <text x="50" y="50">HERE should be WorldVis</text>
                </svg> -->
            </div>
            <div class="col-md-2" id="countVis">
                <!-- TODO: delete placeholder svg element -->
                <svg width="300" height="250" style="background-color: lightcoral">
                    <text x="50" y="50">HERE should be CountVis</text>
                </svg></br></br></br>
                <svg width="300" height="250" style="background-color: lightcoral">
                    <text x="50" y="50">HERE should be CountVis2</text>
                </svg>
            </div>
        </div>


    </div>
    <script>
        $(function(){ // this function is called after the HTML document is fully loaded

            // variables keeping global knowledge of the data
            var co2Data = [];

            // see: https://github.com/mbostock/d3/wiki/Time-Formatting
            var dateFormatter = d3.time.format("%Y-%m-%d");
            // call this function after Data is loaded, reformatted and bound to the variables
            var initVis = function(){

                //Create Event Handler
                var MyEventHandler = new Object();

                //Instantiate Vis Objects
                var count_vis = new WorldVis(d3.select("#worldVis"), co2Data, MyEventHandler);           
            }

            // call this function after both files are loaded -- error should be "null" if no error
            var dataLoaded = function (error, _data) {
                if (!error) {

                    // Wrangle Data
                    flat_data = []

                  _data.Root.data.record.forEach(function(d){
                    if("__text" in d.field[3]){
                    var country_name = d.field[0]["__text"]
                    var country_id = d.field[0]["_key"]
                    var year = d.field[2]["__text"]
                    var emissions = d.field[3]["__text"]

                    flat_data.push({
                        "name": country_name,
                        "year": year,
                        "emissions": emissions,
                        "country_id": country_id

                    })
                    }})
                    
                    var c_array = []
                    var id_array = []

                    flat_data.forEach(function(d){
                      if (c_array.indexOf(d.name) == -1){
                        c_array.push(d.name)
                        id_array.push(d.country_id)
                      }
                    })

                    var clean_data = []

                    var scale = d3.scale.ordinal()

                    scale.domain(d3.range(1960, 2014))
                    scale.range(d3.range(0, 53))

                    console.log(c_array)

                    c_array.forEach(function(d, i){
                     var years = d3.range(53).map(function () {
                          return -1; 
                      });
                      clean_data.push({
                        "name": d,
                        "country_id": id_array[i],
                        "years": years
                      })
                    });

                    flat_data.forEach(function(d){
                      for (var i = 0; i < clean_data.length ; i++){
                        if (clean_data[i].name == d.name){
                          clean_data[i]["years"][scale(d.year)] = d.emissions
                        }
                      }
                    })

                  co2Data = clean_data
                                    

                  initVis();
                                }
                            }
            var startHere = function(){

             //load data here and call "dataLoaded" afterwards
                queue()
                .defer(d3.json, 'data/countries_co2_raw_data.json') 
                .await(dataLoaded); 

                // bind GDP button to a function
                    d3.select("#gdpBtn").on("click", function() {
                        // TODO
                    
                    });
            }
           
            startHere();
        
        })
    </script>
</body>
</html>