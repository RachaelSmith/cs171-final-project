<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>CS171 Final Project</title>

    <!-- ADD Libraries-->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="dm/dist/datamaps.world.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

    <!-- add own scripts-->
    <script src = "js/worldvis.js"></script>
    <script src = "js/countryvis_usage.js"></script>
    <script src = "js/countryvis_compare.js"></script>
    <script src = "js/circlevis.js"></script>
    <script src = "js/temperaturevis.js"></script>

</head>
<body>
    <div class="div1" id="back">
      <div class="div2">
      </div>
    </div>

    <div class="col-md-12">
      <p class="heading-begin" id="1">C&nbspA&nbspR&nbspB&nbspO&nbspN&nbsp E&nbspM&nbspI&nbspS&nbspS&nbspI&nbspO&nbspN&nbspS </p>
      <p class="heading-middle" id="2">an economic perspective</p>
      <a href="#info"><p class="temp_title_begin">WHY IS THIS IMPORTANT?</p></a> 
      <a href="#chapter_one"><p class="heading-end">I already know. Take me to the visualization</p></a>
    </div>
    <a name="info"></a>
    <div class="col-md-12" style="background-color:#F8F8F8">
      <img class="icon" src="images/world.png">
      <p class="title">You’ve probably heard about<text class="emphasis"> global warming</text>.</p>

      <p class="title2">Unsurpringly, it's still very much a reality of the world we live in. Let’s revisit some of the facts.</p>

    </div>
    <div class="col-md-12"  id="temperatures">
        
      <div class="col-md-4" id="title3"><p class="title3"><text class="temp_title">RISING TEMPERATURES</text><br><br>Multiple lines of scientific evidence show that temperatures are rising. This graph compares average annual global surface temperature relative to the average temperature from 1951-1980. The 10 warmest years in the past 135 years have all occurred since 2000, with the exception of 1998. 2014 is ranked the warmest on record. (Data from NASA.)</p></div>
      <div class="col-md-8" id="tempVis">
          <p class="tooltip_temps">Here is where we will say something.</p>
            </div>
    </div>
    <div class="col-md-12" style="background-color:#F8F8F8">
      <p class="title4" id="title4">The effects of rising temperatures aren’t waiting for some far-flung future.</p>
      <p class="temp_title_2">THEY'RE HAPPENING NOW</p>

    </div>
    <div class="effects">
      <div class="hover1" id="hover1"><img class="issues_cover" id="hover1_img" src="images/ice2.jpg"><p class="hover_text" id="hover1_text"><text class="hover_heading">MELTING ICE CAPS</text><br><br>Mountain glaciers, ice sheets covering West Antarctica and Greenland, and Arctic sea ice are melting at alarming rates, causing an upwards trend in the sea levels in the past century.</p></div><div class="hover1" id="hover2"><img class="issues_cover" id="hover2_img" src="images/migration.jpg"><p class="hover_text" id="hover2_text"><text class="hover_heading">THREAT TO BIODIVERSITY</text><br><br>More than 1 million species are facing extinction due to global warming and its negative impact on ecosystems and migration patterns.</p></div><div class="hover1" id="hover3"><img class="issues_cover" id="hover3_img" src="images/hurricane.jpg"><p class="hover_text" id="hover3_text"><text class="hover_heading">NATURAL DISASTERS</text><br><br>There has been a 100% increase in both the duration and intensity of natural calamities occurring on earth since the 1970’s, particularly tropical storms and hurricanes, with a possible link to the increased amount of carbon dioxide in the earth’s atmosphere.</p></div><div class="hover1" id="hover4"><img class="issues_cover" id="hover4_img" src="images/manhattan1.jpg"><p class="hover_text" id="hover4_text"><text class="hover_heading">EFFECT ON HUMAN LIVES</text><br><br>Global warming also impacts humans by loss of habitat from inundation and by threatening food security by decreasing crop yields. </p></div>

    </div>
    <div class="col-md-12" style="background-color:#F8F8F8">  
      <p class="title4" id="title4">The Intergovernmental Panel on Climate Change (IPCC) reported in 2014 that scientists were more than 95% certain that <br>most of global warming is caused by <text class="emphasis_1">increasing concentrations of greenhouse gases</text> and <text class="emphasis_1">other human activities.</text></p>
      <p class="title5">This visualization will explore exactly that.</p>
      <p class="temp_title_3">READY?</p>
      <a href="#chapter_one"><p class="temp_title_4">TAKE ME TO THE VISUALIZATION</p></a>
 
    </div>
    <!--beginning of chapter one-->

    <div class="container">
      <a name="chapter_one" id="chapter_one"></a>
        <p class="history_title">A HISTORY OF CARBON EMISSIONS AND ENERGY CONSUMPTION</p>

        <div class="row">
            <div class="col-md-5">
                <button class="btn_on" type="submit" value="gdp" id="gdpBtn"> GDP </button>
                <button class="history_btn" type="submit" value="p hop" id="popBtn"> POPULATION </button>
                <!--<button class="history_btn" type="submit" value="forest" id="forestBtn"> FOREST % </button>-->
            </div>


        </div>
        <div class="history_text">here is where info will go</div>

        <div class="row">
            <div class="col-md-12" id="worldVis">

            </div>

        </div>
            <div id="countVis">

            </div>
        
  </br></br>
        <div class="row">
            <div id="circleVis">
              Node Size:
                <button class="btn btn-sm btn-info" type="submit" value="total" id="totalBtn"> Total CO2 </button>
                <button class="btn btn-sm btn-info" type="submit" value="percap" id="percapBtn"> Per Capita CO2 </button>
                Group By:
                 <button class="btn btn-sm btn-info" type="submit" value="location" id="locationBtn"> Geographic Location </button>
                <button class="btn btn-sm btn-info" type="submit" value="income" id="grpBtn"> Income level </button>
            </div>
        </div>


    </div>
    <script>
        //to fade things in
        var fs = 1000;
        var fs_2 = 0;

        $("#back").fadeIn(fs);
        
        // this function is called after the HTML document is fully loaded
        $(function(){ 
            
            // variables keeping global knowledge of the data
            var co2Data = [];

            var engData = [];

            // see: https://github.com/mbostock/d3/wiki/Time-Formatting
            var dateFormatter = d3.time.format("%Y-%m-%d");
            // call this function after Data is loaded, reformatted and bound to the variables
            var initVis = function(){

                //temperature data
                var temperature_array = [-23,   -15,  -18,  -21,  -29,  -27,  -26,  -33,  -21,  -11,  -34,  -27,  -32,  -36,  -33,  -26,  -19,  -19,  -32,  -21,  -16,  -21,  -31,  -37,  -45,  -31,  -27,  -43,  -44,  -48,  -47,  -45,  -42,  -40,  -24,  -17,  -37,  -45,  -32,  -30,  -28,  -21,  -30,  -27,  -25,  -23,  -11,  -20,  -17,  -32,  -13,  -8,   -11,  -26,  -10,  -16,  -11,  2,  5,  0,  6,  7,  5,  5,  13,   0,  -8,   -5,   -11,  -12,  -19,  -7,   1,  8,  -12,  -13,  -18,  3,  5,  3,  -4,   6,  4,  8,  -20,  -10,  -4,   -1,   -5,   6,  4,  -6,   2,  16,   -7,   -1,   -12,  15,   5,  12,   23,   28,   9,  27,   12,   8,  14,   28,   35,   24,   39,   38,   19,   21,   28,   43,   32,   45,   61,   40,   40,   52,   61,   60,   51,   65,   59,   62,   49,   59,   66,   55,   57,   60,   67];


                //Create Event Handler
                var MyEventHandler = new Object();

                //Instantiate Vis Objects
                
                var temperature_vis = new TempVis(d3.select("#tempVis"), temperature_array);
                var count_usage_vis = new CountryUVis(d3.select("#countVis"), engData);
                var count_comp_vis = new CountryPVis(d3.select("#countVis"), engData, co2Data);
                var world_vis = new WorldVis(d3.select("#worldVis"), co2Data, MyEventHandler);  
                var circle_vis = new CircleVis(d3.select("#circleVis"), co2Data) 

                // Bind the eventHandler to the Vis Objects
                $(MyEventHandler).bind("selectionChanged", function(event, selection){

                    count_usage_vis.onSelectionChange(selection);
                    count_comp_vis.onSelectionChange(selection);

                })

                //d3.select("input[value=\"gdp\"]").on("click", new WorldVis(d3.select("#worldVis"), co2Data, MyEventHandler) );
                var button_gdp = document.getElementById("gdpBtn");
                button_gdp.addEventListener("click", function() { 
                  world_vis.wrangleData_gdp();  
                });

                var button_pop = document.getElementById("popBtn");
                button_pop.addEventListener("click", function() { 
                  world_vis.wrangleData_pop();  
                });

                 var button_co2ttl = document.getElementById("totalBtn");
                button_co2ttl.addEventListener("click", function() { 
                  circle_vis.wrangleData(this.value);  
                });

                var button_percap = document.getElementById("percapBtn");
                button_percap.addEventListener("click", function() { 
                  circle_vis.wrangleData(this.value);  
                });

                var button_loc = document.getElementById("locationBtn");
                button_loc.addEventListener("click", function() { 
                  circle_vis.wrangleData(this.value);  
                });

                var button_income = document.getElementById("grpBtn");
                button_income.addEventListener("click", function() { 
                  circle_vis.wrangleData(this.value);  
                });

            }



            // call this function after both files are loaded -- error should be "null" if no error
            var dataLoaded = function (error, _data, _gdpdata, _popdata, _longlat, _totaldata, _altdata, _combdata, _fordata, _metadata) {
                if (!error) {

                //Function to wrangle raw data 
                function flatData (data){

                      var clean = []



                      data.Root.data.record.forEach(function(d){
                        if("__text" in d.field[3]){
                        var country_name = d.field[0]["__text"]
                        var country_id = d.field[0]["_key"]
                        var year = d.field[2]["__text"]
                        var par = d.field[3]["__text"]


                        clean.push({
                            "name": country_name,
                            "year": year,
                            "param" : par,
                            "country_id": country_id

                        })
                        }})
                      return clean
                     }
                    
                    //Flattened Versions of each dataset
                    var clean_co2 = flatData(_data)
                    var clean_gdp = flatData(_gdpdata)
                    var clean_pop = flatData(_popdata)
                    var clean_for = flatData(_fordata)
                    var clean_eng = flatData(_totaldata)
                    var clean_alt = flatData(_altdata)
                    var clean_comb = flatData(_combdata)

                    
                    //Condense gdp, co2, forest area and population datasets
                    var c_array = []
                    var id_array = []

                        clean_co2.forEach(function(d){
                          if (c_array.indexOf(d.name) == -1){
                            c_array.push(d.name)
                            id_array.push(d.country_id)
                          }
                        })

                        var cleanest_data = []

                        var scale = d3.scale.ordinal()

                        scale.domain(d3.range(1960, 2013))
                        scale.range(d3.range(0, 54))


                        //create object for each country
                        c_array.forEach(function(d, i){ 

                        var region = null
                        var income_group = null 


                        //Extract country metadata, if it exists
                        _metadata.forEach(function(m){
                          if (m.Code == id_array[i]){
                            income_group = m["Income Group"]
                            region = m["Region"]
                          }
                        })

                        //create empty arrays to contain gdp, population, and emissions values for each year
                        var emptyarray = d3.range(53).map(function () {return -1;})
                        var emptyarray2 = d3.range(53).map(function () {return -1; })
                        var emptyarray3 = d3.range(53).map(function () {return -1; })
                        var emptyarray4 = d3.range(53).map(function () {return -1; })

               
                         //extract latitute and logitude data
                         var lon = -1
                         var lat = -1
                         _longlat.data.forEach(function(d){
                          if (d[10] == id_array[i]){
                            lon = d[13]
                            lat = d[12]
                          }
                         });

                          cleanest_data.push({
                            "name": d,
                            "country_id": id_array[i],
                            "region": region,
                            "income_group": income_group,
                            "years": emptyarray,
                             "gdp": emptyarray2,
                             "pop": emptyarray3,
                             "forest" : emptyarray4,
                            "longitude": lon,
                            "latitude": lat
                          })
                        });

                        //Fill values for co2 in each country object, for each year                      
                        clean_co2.forEach(function(d){
                          for (var i = 0; i < cleanest_data.length ; i++){
                            if (cleanest_data[i].name == d.name){
                              cleanest_data[i].years[scale(d.year)] = d.param
                            }
                          }
                        })

                        //Fill values for gdp in each country object, for each year                      
                        clean_gdp.forEach(function(d){
                          for (var i = 0; i < cleanest_data.length ; i++){
                            if (cleanest_data[i].name == d.name){
                              cleanest_data[i]["gdp"][scale(d.year)] = d.param
                            }
                          }
                        })

                        //Fill values for population in each country object, for each year                      
                        clean_pop.forEach(function(d){
                          for (var i = 0; i < cleanest_data.length ; i++){
                            if (cleanest_data[i].name == d.name){
                              cleanest_data[i]["pop"][scale(d.year)] = d.param
                            }
                          }
                        })
                        
                        //Fill values for forest area in each country object, for each year
                        clean_for.forEach(function(d){
                          for (var i = 0; i < cleanest_data.length ; i++){
                            if (cleanest_data[i].name == d.name){
                              cleanest_data[i]["forest"][scale(d.year)] = d.param
                            }
                          }
                        })

                //Save co2, gdp, population to global variable
                  co2Data = cleanest_data 

                //Consolodate energy data
                    var ec_array = []
                    var eid_array = []

                    clean_eng.forEach(function(d){
                      if (ec_array.indexOf(d.name) == -1){
                        ec_array.push(d.name)
                        eid_array.push(d.country_id)
                      }
                    })
                    
                    //Array to store consolodated energy data
                    var cleanest_edata = []

                    //Instantiate one object for each country
                    ec_array.forEach(function(d, i){
                     var arr1 = d3.range(53).map(function () {return -1; });
                     var arr2 = d3.range(53).map(function () {return -1; });
                     var arr3 = d3.range(53).map(function () {return -1;});


                      cleanest_edata.push({
                        "name": d,
                        "country_id": eid_array[i],
                        "total_energy_use": arr1,
                        "alt_energy_use": arr2,
                        "comb_energy_use": arr3
                      })
                    });

                    //Populate country arrays with values for energy for each year
                    clean_eng.forEach(function(d){
                      for (var i = 0; i < cleanest_edata.length ; i++){
                        if (cleanest_edata[i].name == d.name){
                          cleanest_edata[i]["total_energy_use"][scale(d.year)] = d.param
                        }
                      }
                    })

                    clean_alt.forEach(function(d){
                      for (var i = 0; i < cleanest_edata.length ; i++){
                        if (cleanest_edata[i].name == d.name){
                          cleanest_edata[i]["alt_energy_use"][scale(d.year)] = d.param
                        }
                      }
                    })

                    clean_comb.forEach(function(d){
                      for (var i = 0; i < cleanest_edata.length ; i++){
                        if (cleanest_edata[i].name == d.name){
                          cleanest_edata[i]["comb_energy_use"][scale(d.year)] = d.param
                        }
                      }
                    })

                    //Store consolodated energy data in global variable
                    engData = cleanest_edata

                  initVis();
                                }
                            }
            var startHere = function(){

             //load data here and call "dataLoaded" afterwards
                queue()
                .defer(d3.json, 'data/countries_co2_raw_data.json')
                .defer(d3.json, 'data/gdp_raw_data.json')
                .defer(d3.json, 'data/pop_raw_data.json')
                .defer(d3.json, 'data/long_lat.json')
                .defer(d3.json, 'data/energy_use_ktoil_raw_data.json')
                .defer(d3.json, 'data/alt_nuc_eng_raw_data.json')
                .defer(d3.json, 'data/combust_renew_raw_data.json')
                .defer(d3.json, 'data/forest_area_raw_data.json')
                .defer(d3.json, 'data/country_metadata.json')

                .await(dataLoaded);

                // bind GDP button to a function
                    d3.select("#gdpBtn").on("click", function() {
                        d3.select("#gdpBtn")
                          .attr("class", "btn_on");
                        d3.select("#popBtn")
                          .attr("class", "history_btn");  
                    
                    });

                    d3.select("#popBtn").on("click", function() {
                        d3.select("#gdpBtn")
                          .attr("class", "history_btn");
                        d3.select("#popBtn")
                          .attr("class", "btn_on");  
                    
                    });
            }
           
            startHere();
        
        })
    </script>
</body>
</html>